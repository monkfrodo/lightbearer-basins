<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lightbearer – Basins</title>
<style>
  :root {
    --bg: #0b1220;
    --bg-grad: linear-gradient(180deg, #0b1220 0%, #0f172a 100%);
    --card: rgba(255,255,255,0.03);
    --muted: #8fa1c2;
    --accent: #3b82f6;
    --safe: #22c55e;
    --warn: #eab308;
    --risk: #f59e0b;
    --crit: #ef4444;
    --radius: 16px;
  }

  * {box-sizing: border-box;}
  body {
    margin: 0;
    font-family: "Inter", system-ui, sans-serif;
    background: var(--bg-grad);
    color: #e5ecff;
    line-height: 1.5;
  }

  .wrap {
    max-width: 1100px;
    margin: 40px auto;
    padding: 0 16px;
  }

  h1 {
    font-size: 26px;
    margin: 0 0 8px;
    font-weight: 700;
  }

  .subtitle {
    color: var(--muted);
    font-size: 14px;
    margin-bottom: 20px;
  }

  .card {
    background: var(--card);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    margin-bottom: 24px;
  }

  .form {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
    gap: 12px;
    align-items: end;
  }

  label {
    font-size: 13px;
    color: var(--muted);
    display: block;
    margin-bottom: 6px;
  }

  input, select, button {
    width: 100%;
    padding: 12px 14px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.08);
    background: #111b33;
    color: #e5ecff;
    font-size: 15px;
  }

  button {
    cursor: pointer;
    font-weight: 600;
    transition: 0.2s;
  }

  button:hover {
    opacity: 0.9;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
    border: none;
  }

  .btn-secondary {
    background: #334155;
    color: #e5ecff;
    border: none;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
    gap: 16px;
  }

  .basin {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: var(--radius);
    padding: 16px;
    transition: transform 0.2s ease, background 0.3s ease;
  }

  .basin:hover {
    transform: translateY(-3px);
    background: rgba(255,255,255,0.07);
  }

  .title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 700;
    font-size: 16px;
  }

  .badge {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 999px;
    font-weight: 600;
  }

  .badge.safe  { background: rgba(34,197,94,0.15); color: var(--safe); }
  .badge.warn  { background: rgba(234,179,8,0.15); color: var(--warn); }
  .badge.risk  { background: rgba(245,158,11,0.15); color: var(--risk); }
  .badge.crit  { background: rgba(239,68,68,0.15); color: var(--crit); animation: blink 1s linear infinite; }

  @keyframes blink { 50% { opacity: .5; } }

  .muted { color: var(--muted); font-size: 13px; }
  .due { margin-top: 8px; font-size: 14px; font-weight: 500; }

  .bar {
    margin-top: 12px;
    height: 8px;
    background: #0b1220;
    border-radius: 999px;
    overflow: hidden;
  }

  .fill {
    height: 100%;
    width: 0%;
    transition: width 1s linear, background-color 0.5s ease;
  }

  .fill.safe { background: var(--safe); }
  .fill.warn { background: var(--warn); }
  .fill.risk { background: var(--risk); }
  .fill.crit { background: var(--crit); }

  .footer {
    margin-top: 30px;
    color: var(--muted);
    font-size: 13px;
    text-align: center;
    border-top: 1px solid rgba(255,255,255,0.1);
    padding-top: 20px;
  }

  #status {
    color: var(--muted);
    margin-top: 8px;
    font-size: 13px;
  }

  @media (max-width: 600px){
    .wrap { padding: 0 10px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Lightbearer – Basins</h1>
  <div class="subtitle">Registre um acendimento (reacender a cada 3h). Seu fuso é detectado automaticamente.</div>

  <div class="card">
    <form id="f">
      <input type="hidden" name="fn" value="submit"/>
      <div class="form">
        <div>
          <label>Player</label>
          <input name="player" id="player" placeholder="Seu char" autocomplete="off"/>
        </div>
        <div>
          <label>Basin</label>
          <select name="basin" id="basin"></select>
        </div>
        <div>
          <label>Data e hora (seu horário)</label>
          <input id="dt" type="datetime-local"/>
        </div>
        <div style="display:flex;gap:8px;">
          <button type="button" id="nowBtn" class="btn-secondary">Agora</button>
          <button type="submit" id="sendBtn" class="btn-primary">Acender / Registrar</button>
          <button type="button" id="refreshBtn" class="btn-secondary">Atualizar</button>
        </div>
      </div>
      <input type="hidden" name="typed" id="typed"/>
      <input type="hidden" name="tz" id="tz"/>
      <input type="hidden" name="ms" id="ms"/>
    </form>
    <div id="status"></div>
  </div>

  <div class="grid" id="grid"></div>

  <div class="footer" id="footer">
    SLA 3h · Exibição base: <span id="tzLabel"></span><br><br>
    <strong>Blackout Guild | Todos os direitos reservados.</strong>
  </div>
</div>

<script>
  const APPS = "https://script.google.com/macros/s/AKfycbzV1cJajlmwysGL3N0QeJoN5Xqmrrd-ljdvh1EL2997Xtg8xL-sReuaTEO5Asm77U9h/exec";
  const FULL = 3 * 3600;
  const pad = n => String(n).padStart(2,'0');
  const state = { items:[], slaHours:3, serverNowMs:null, clientNowAtFetch:null };

  function fmtLocal(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    return d.toLocaleString('pt-BR', { hour12: false });
  }

  function fmtCountdown(sec) {
    const sign = sec < 0 ? '-' : '';
    const s = Math.abs(sec);
    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), ss = s%60;
    return `${sign}${pad(h)}:${pad(m)}:${pad(ss)}`;
  }

  function bucket(sec) {
    if (sec == null) return 'safe';
    if (sec >= 120*60) return 'safe';
    if (sec >= 60*60)  return 'warn';
    if (sec >= 30*60)  return 'risk';
    return 'crit';
  }

  async function sendForm(fd) {
    try {
      document.getElementById('status').textContent = 'Enviando...';
      await fetch(APPS, { method: "POST", mode: "no-cors", body: fd });
      document.getElementById('status').textContent = 'Registrado!';
      loadState();
    } catch (e) {
      document.getElementById('status').textContent = 'Erro ao enviar.';
    }
  }

  function loadState() {
    document.getElementById('status').textContent = 'Carregando...';
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    window[cb] = data => {
      delete window[cb];
      document.getElementById('status').textContent = '';
      state.items = data.items || [];
      state.slaHours = data.slaHours;
      state.serverNowMs = data.now || Date.now();
      state.clientNowAtFetch = Date.now();
      render();
      startTick();
    };
    const s = document.createElement('script');
    s.src = APPS + '?fn=state&callback=' + cb;
    document.body.appendChild(s);
  }

  function render() {
    document.getElementById('tzLabel').textContent = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const sel = document.getElementById('basin');
    sel.innerHTML = '';
    state.items.forEach(it => {
      const o = document.createElement('option');
      o.value = it.basin;
      o.textContent = it.basin;
      sel.appendChild(o);
    });

    const grid = document.getElementById('grid');
    grid.innerHTML = '';

    state.items.forEach(it => {
      const div = document.createElement('div');
      div.className = 'basin';
      const k = bucket(it.remainingSec);
      const title = `<div class="title"><span>${it.basin}</span><span class="badge ${k}">${{safe:'SEGURO',warn:'ATENÇÃO',risk:'RISCO',crit:'CRÍTICO'}[k]}</span></div>`;
      const last = it.lastIsoUtc ? `<div class="muted">Último: <b>${fmtLocal(it.lastIsoUtc)}</b> · ${it.lastPlayer ? it.lastPlayer : ''}</div>` : `<div class="muted">Sem registros ainda</div>`;
      const next = it.nextDueIsoBase ? `<div class="due">Próx.: <b>${fmtLocal(it.nextDueIsoBase)}</b> · <span id="cd-${it.basin.replace(/[^a-z0-9]/gi,'')}"></span></div>` : '';
      const bar = `<div class="bar"><div class="fill ${k}" id="fill-${it.basin.replace(/[^a-z0-9]/gi,'')}"></div></div>`;
      div.innerHTML = title + last + next + bar;
      grid.appendChild(div);
    });
  }

  function startTick() {
    if (window._tick) clearInterval(window._tick);
    const drift = (state.serverNowMs ?? Date.now()) - (state.clientNowAtFetch ?? Date.now());
    window._tick = setInterval(() => {
      state.items.forEach(it => {
        if (it.remainingSec == null) return;
        const now = Date.now() + drift;
        if (!it._nextDueMs) it._nextDueMs = state.serverNowMs + it.remainingSec*1000;
        const rem = Math.floor((it._nextDueMs - now)/1000);
        const el = document.getElementById('cd-' + it.basin.replace(/[^a-z0-9]/gi,''));
        if (el) el.textContent = fmtCountdown(rem);
        const fill = document.getElementById('fill-' + it.basin.replace(/[^a-z0-9]/gi,''));
        if (fill) {
          const spent = Math.max(0, Math.min(FULL, FULL - Math.max(0, rem)));
          fill.style.width = ((spent/FULL)*100).toFixed(1) + '%';
          const newK = bucket(rem);
          ['safe','warn','risk','crit'].forEach(c=>fill.classList.remove(c));
          fill.classList.add(newK);
        }
      });
    }, 1000);
  }

  function setNow() {
    const d = new Date();
    const v = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    document.getElementById('dt').value = v;
  }

  document.getElementById('f').addEventListener('submit', e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const dt = document.getElementById('dt').value;
    const ms = dt ? new Date(dt).getTime() : Date.now();
    fd.set('typed', dt || '');
    fd.set('ms', String(ms));
    fd.set('tz', Intl.DateTimeFormat().resolvedOptions().timeZone || '');
    sendForm(fd);
  });

  document.getElementById('nowBtn').addEventListener('click', setNow);
  document.getElementById('refreshBtn').addEventListener('click', loadState);
  setNow();
  loadState();
</script>
</body>
</html>
