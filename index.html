<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>The Lightbearer | Luminera | Blackout</title>
  <style>
    :root {
      --bg: #0b1220;
      --accent: #3b82f6;
      --muted: #8fa1c2;
      --safe: #22c55e;
      --warn: #eab308;
      --risk: #f59e0b;
      --crit: #ef4444;
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, sans-serif;
      background: var(--bg) url('https://static.tibia.com/images/news/lightbearer_280.png') no-repeat center top;
      background-size: cover;
      background-attachment: fixed;
      color: #e5ecff;
      min-height: 100vh;
      position: relative;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: linear-gradient(rgba(0,0,0,0.65), rgba(0,0,0,0.8));
      pointer-events: none;
      z-index: 0;
    }
    .wrap {
      position: relative;
      z-index: 1;
      max-width: 1100px;
      margin: 0 auto;
      padding: 60px 16px 40px;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .lang-select select {
      background: #10182b;
      color: #e5ecff;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 14px;
    }
    .ss-badge {
      background: rgba(34,197,94,0.1);
      color: var(--safe);
      border: 1px solid var(--safe);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .ss-badge img {
      width: 16px;
      height: 16px;
    }
    h1 {
      font-size: 28px;
      margin: 0 0 10px;
      font-weight: 800;
      text-align: center;
    }
    .subtitle {
      text-align: center;
      color: var(--muted);
      font-size: 15px;
      margin-bottom: 30px;
    }
    .card {
      background: rgba(10,15,25,0.85);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: 0 4px 25px rgba(0,0,0,0.3);
      margin-bottom: 30px;
    }
    .form {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap: 16px;
      align-items: end;
    }
    label {
      font-size: 13px;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }
    input, select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      background: #10182b;
      color: #e5ecff;
      font-size: 15px;
    }
    .buttons {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 22px;
    }
    button {
      padding: 14px 26px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 140px;
      font-size: 15px;
    }
    button:hover {
      opacity: .9;
      transform: translateY(-1px);
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
    }
    .btn-secondary {
      background: #334155;
      color: #e5ecff;
    }
    @media (min-width: 900px) {
      .buttons { margin-top: 30px; gap: 20px; }
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
      gap: 16px;
    }
    .basin {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      padding: 16px;
      transition: 0.3s;
    }
    .basin:hover {
      background: rgba(255,255,255,0.1);
      transform: translateY(-2px);
    }
    .title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
    }
    .badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 600;
    }
    .badge.safe  { background: rgba(34,197,94,0.15);   color: var(--safe); }
    .badge.warn  { background: rgba(234,179,8,0.15);   color: var(--warn); }
    .badge.risk  { background: rgba(245,158,11,0.15);  color: var(--risk); }
    .badge.crit  { background: rgba(239,68,68,0.15);  color: var(--crit); animation: blink 1s linear infinite; }
    @keyframes blink { 50% { opacity: .5; } }
    .muted  { color: var(--muted); font-size: 13px; }
    .due    { margin-top: 8px; font-size: 14px; }
    .bar    { margin-top: 10px; height: 8px; background: #0b1220; border-radius: 999px; overflow: hidden; }
    .fill   { height: 100%; width: 0%; transition: width 1s linear, background 0.5s ease; }
    .fill.safe { background: var(--safe); }
    .fill.warn { background: var(--warn); }
    .fill.risk { background: var(--risk); }
    .fill.crit { background: var(--crit); box-shadow:0 0 10px 2px var(--crit); }
    .footer {
      margin-top: 40px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      border-top: 1px solid rgba(255,255,255,.1);
      padding-top: 20px;
    }
    .icon {
      display:flex;
      justify-content:center;
      margin-top:25px;
    }
    .icon img {
      width:120px;
      opacity:.8;
    }
    @media (min-width:900px) {
      .icon img { width:160px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="lang-select">
        <select id="lang">
          <option value="en">üá∫üá∏ English</option>
          <option value="es">üá≤üáΩ Espa√±ol</option>
          <option value="pt" selected>üáßüá∑ Portugu√™s</option>
        </select>
      </div>
      <div class="ss-badge" id="ssBadge">
        <img src="https://cdn-icons-png.flaticon.com/512/1041/1041883.png" alt="clock">
        <span id="ssText">SS+0</span>
      </div>
    </div>

    <h1 id="title">The Lightbearer | Luminera | Blackout</h1>
    <div class="subtitle" id="subtitle">Registre um acendimento (reacender a cada 3h). Seu fuso √© detectado automaticamente.</div>

    <div class="card">
      <form id="f">
        <input type="hidden" name="fn" value="submit"/>
        <div class="form">
          <div>
            <label id="lblPlayer">Player</label>
            <input name="player" id="player" placeholder="Seu char" autocomplete="off"/>
          </div>
          <div>
            <label id="lblBasin">Basin</label>
            <select name="basin" id="basin"></select>
          </div>
          <div>
            <label id="lblDatetime">Data e hora (seu hor√°rio)</label>
            <input id="dt" type="datetime-local"/>
          </div>
        </div>
        <div class="buttons">
          <button type="button" id="nowBtn" class="btn-secondary">Agora</button>
          <button type="submit" id="sendBtn" class="btn-primary">Acender / Registrar</button>
          <button type="button" id="refreshBtn" class="btn-secondary">Atualizar</button>
        </div>
        <input type="hidden" name="typed" id="typed"/>
        <input type="hidden" name="tz" id="tz"/>
        <input type="hidden" name="ms" id="ms"/>
      </form>
      <div id="status" class="muted" style="text-align:center;margin-top:10px;"></div>
    </div>

    <div class="grid" id="grid"></div>

    <div class="footer">
      SLA 3h ¬∑ Exibi√ß√£o base: <span id="tzLabel"></span><br><br>
      <strong>Blackout Guild | Todos os direitos reservados.</strong>
      <div class="icon">
        <img src="https://static.tibia.com/images/news/lightbearer_280.png" alt="Lightbearer Icon">
      </div>
    </div>
  </div>

  <script>
    const APPS = "https://script.google.com/macros/s/AKfycbzV1cJajlmwysGL3N0QeJoN5Xqmrrd-ljdvh1EL2997Xtg8xL-sReuaTEO5Asm77U9h/exec";
    const FULL = 3 * 3600;
    const pad = n => String(n).padStart(2, '0');
    const state = { items: [], slaHours: 3, serverNowMs: null, clientNowAtFetch: null };

    /* --- Server Save Timer --- */
    function updateSSBadge(){
      const badge = document.getElementById('ssText');
      const now = new Date();
      const tz = "America/Sao_Paulo";
      const nowSP = new Date(now.toLocaleString("en-US", { timeZone: tz }));
      const ss = new Date(nowSP);
      ss.setHours(6, 0, 0, 0);
      if(nowSP < ss) ss.setDate(ss.getDate()-1);

      const diffMs = nowSP - ss;
      const diffH = diffMs / (1000*60*60);
      const hours = Math.floor(diffH);
      const minutes = Math.floor((diffH - hours)*60);
      const remaining = 60 - minutes;

      if(hours < 24){
        badge.textContent = `SS+${hours} (${remaining}m restantes)`;
      } else {
        badge.textContent = `SS+24 (aguardando novo SS)`;
      }
    }
    setInterval(updateSSBadge, 60000);
    updateSSBadge();

    /* --- Language Switch --- */
    const LANG = {
      pt: { player:"Player", basin:"Basin", date:"Data e hora (seu hor√°rio)", register:"Acender / Registrar", refresh:"Atualizar", now:"Agora" },
      en: { player:"Player", basin:"Basin", date:"Date & time (your local)", register:"Light / Register", refresh:"Refresh", now:"Now" },
      es: { player:"Jugador", basin:"Basin", date:"Fecha y hora (tu zona horaria)", register:"Encender / Registrar", refresh:"Actualizar", now:"Ahora" }
    };
    function applyLang(l){
      const t = LANG[l] || LANG.pt;
      document.getElementById('lblPlayer').textContent = t.player;
      document.getElementById('lblBasin').textContent  = t.basin;
      document.getElementById('lblDatetime').textContent = t.date;
      document.getElementById('nowBtn').textContent = t.now;
      document.getElementById('sendBtn').textContent = t.register;
      document.getElementById('refreshBtn').textContent = t.refresh;
    }
    const langSelect = document.getElementById('lang');
    const savedLang = localStorage.getItem('lang') || 'pt';
    langSelect.value = savedLang;
    applyLang(savedLang);
    langSelect.addEventListener('change', e => {
      localStorage.setItem('lang', e.target.value);
      applyLang(e.target.value);
    });

    /* --- Fun√ß√µes originais mantidas --- */
    function fmtLocal(iso){
      if(!iso) return "";
      const d = new Date(iso);
      return d.toLocaleString('pt-BR',{hour12:false});
    }
    function fmtCountdown(sec){
      const s = Math.abs(sec);
      const sign = sec < 0 ? '-' : '';
      const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), ss = s%60;
      return `${sign}${pad(h)}:${pad(m)}:${pad(ss)}`;
    }
    function bucket(sec){
      if(sec==null) return 'safe';
      if(sec>=120*60) return 'safe';
      if(sec>=60*60)  return 'warn';
      if(sec>=30*60)  return 'risk';
      return 'crit';
    }
    async function sendForm(fd){
      try{
        document.getElementById('status').textContent = LANG[langSelect.value].status || "Registrado!";
        await fetch(APPS, { method:"POST", mode:"no-cors", body:fd });
        loadState();
      } catch(e){
        document.getElementById('status').textContent = "Erro ao enviar.";
      }
    }
    function loadState(){
      document.getElementById('status').textContent = "Carregando...";
      const cb = "cb_" + Math.random().toString(36).slice(2);
      window[cb] = data => {
        delete window[cb];
        document.getElementById('status').textContent = "";
        state.items = data.items || [];
        state.slaHours = data.slaHours;
        state.serverNowMs = data.now || Date.now();
        state.clientNowAtFetch = Date.now();
        render();
        startTick();
      };
      const s = document.createElement("script");
      s.src = APPS + "?fn=state&callback=" + cb;
      document.body.appendChild(s);
    }
    function render(){
      document.getElementById('tzLabel').textContent = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const sel = document.getElementById('basin');
      sel.innerHTML = "";
      state.items.forEach(it=>{
        const o = document.createElement("option");
        o.value = it.basin;
        o.textContent = it.basin;
        sel.appendChild(o);
      });
      const grid = document.getElementById('grid');
      grid.innerHTML = "";
      state.items.forEach(it=>{
        const div = document.createElement("div");
        div.className = "basin";
        const k = bucket(it.remainingSec);
        const title = `<div class="title"><span>${it.basin}</span><span class="badge ${k}">${{safe:"SEGURO",warn:"ATEN√á√ÉO",risk:"RISCO",crit:"CR√çTICO"}[k]}</span></div>`;
        const last  = it.lastIsoUtc ? `<div class="muted">√öltimo: <b>${fmtLocal(it.lastIsoUtc)}</b> ¬∑ ${it.lastPlayer||""}</div>` : `<div class="muted">Sem registros ainda</div>`;
        const next  = it.nextDueIsoBase ? `<div class="due">Pr√≥x.: <b>${fmtLocal(it.nextDueIsoBase)}</b> ¬∑ <span id="cd-${it.basin.replace(/[^a-z0-9]/gi,"")}"></span></div>` : "";
        const bar   = `<div class="bar"><div class="fill ${k}" id="fill-${it.basin.replace(/[^a-z0-9]/gi,"")}"></div></div>`;
        div.innerHTML = title + last + next + bar;
        grid.appendChild(div);
      });
    }
    function startTick(){
      if(window._tick) clearInterval(window._tick);
      const drift = (state.serverNowMs ?? Date.now()) - (state.clientNowAtFetch ?? Date.now());
      window._tick = setInterval(() => {
        state.items.forEach(it=>{
          if(it.remainingSec == null) return;
          const now = Date.now() + drift;
          if(!it._nextDueMs) it._nextDueMs = state.serverNowMs + it.remainingSec*1000;
          const rem = Math.floor((it._nextDueMs - now)/1000);
          const el = document.getElementById("cd-"+ it.basin.replace(/[^a-z0-9]/gi,""));
          if(el) el.textContent = fmtCountdown(rem);
          const fill = document.getElementById("fill-"+ it.basin.replace(/[^a-z0-9]/gi,""));
          if(fill){
            const spent = Math.max(0, Math.min(FULL, FULL - Math.max(0, rem)));
            fill.style.width = ((spent/FULL)*100).toFixed(1) + "%";
            const newK = bucket(rem);
            ["safe","warn","risk","crit"].forEach(c=>fill.classList.remove(c));
            fill.classList.add(newK);
          }
        });
      },1000);
    }
    function setNow(){
      const d = new Date();
      const v = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      document.getElementById("dt").value = v;
    }
    document.getElementById("f").addEventListener("submit",e=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const dt = document.getElementById("dt").value;
      const ms = dt ? new Date(dt).getTime() : Date.now();
      fd.set('typed', dt || "");
      fd.set('ms',   String(ms));
      fd.set('tz',   Intl.DateTimeFormat().resolvedOptions().timeZone || "");
      sendForm(fd);
    });
    document.getElementById("nowBtn").addEventListener("click", setNow);
    document.getElementById("refreshBtn").addEventListener("click", loadState);
    setNow();
    loadState();
  </script>
</body>
</html>
