<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lightbearer – Basins</title>
<style>
  :root{--bg:#0b1220;--card:#101a30;--muted:#8fa1c2;--accent:#60a5fa;--safe:#22c55e;--warn:#eab308;--risk:#f59e0b;--crit:#ef4444}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#e5ecff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 12px;display:flex;gap:12px;align-items:center}
  .subtitle{color:var(--muted);font-size:13px;margin-bottom:16px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:14px}
  .form{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;align-items:end;margin-bottom:16px}
  label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
  input,select,button{width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0f1730;color:#e5ecff;font-size:16px}
  button{cursor:pointer;background:var(--accent);border:none;color:#0b1220;font-weight:700}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .basin{background:#0f1730;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px}
  .title{display:flex;justify-content:space-between;align-items:center;font-weight:700}
  .badge{font-size:11px;padding:3px 10px;border-radius:999px}
  .badge.safe{background:rgba(34,197,94,.15);color:var(--safe)}
  .badge.warn{background:rgba(234,179,8,.15);color:var(--warn)}
  .badge.risk{background:rgba(245,158,11,.15);color:var(--risk)}
  .badge.crit{background:rgba(239,68,68,.15);color:var(--crit);animation:blink 1s linear infinite}
  @keyframes blink{50%{opacity:.55}}
  .muted{color:var(--muted);font-size:12px}
  .due{margin-top:8px;font-size:13px}
  .footer{margin-top:16px;color:var(--muted);font-size:12px}
  .bar{margin-top:10px;height:8px;background:#0b1220;border-radius:999px;overflow:hidden}
  .fill{height:100%;width:0%}
  .fill.safe{background:var(--safe)} .fill.warn{background:var(--warn)}
  .fill.risk{background:var(--risk)} .fill.crit{background:var(--crit)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Lightbearer – Basins</h1>
  <div class="subtitle">Registre um acendimento (reacender a cada 3h). Seu fuso é detectado automaticamente.</div>

  <div class="card">
    <form id="f" method="post" target="hidden_iframe" action="https://script.google.com/macros/s/AKfycbzV1cJajlmwysGL3N0QeJoN5Xqmrrd-ljdvh1EL2997Xtg8xL-sReuaTEO5Asm77U9h/exec">
      <input type="hidden" name="fn" value="submit"/>
      <div class="form">
        <div><label>Player</label><input name="player" id="player" placeholder="Seu char" autocomplete="off"/></div>
        <div><label>Basin</label><select name="basin" id="basin"></select></div>
        <div><label>Data e hora (seu horário)</label><input id="dt" type="datetime-local"/></div>
        <div style="display:flex;gap:8px;">
          <button type="button" id="nowBtn">Agora</button>
          <button type="submit" id="sendBtn">Acender / Registrar</button>
          <button type="button" id="refreshBtn" style="background:#334155;color:#e5ecff">Atualizar</button>
        </div>
      </div>
      <input type="hidden" name="typed" id="typed"/>
      <input type="hidden" name="tz" id="tz"/>
      <input type="hidden" name="ms" id="ms"/>
    </form>
    <iframe name="hidden_iframe" style="display:none"></iframe>
    <div id="status" class="muted"></div>
  </div>

  <div class="grid" id="grid"></div>
  <div class="footer" id="footer"></div>
</div>

<script>
  const APPS = "https://script.google.com/macros/s/AKfycbzV1cJajlmwysGL3N0QeJoN5Xqmrrd-ljdvh1EL2997Xtg8xL-sReuaTEO5Asm77U9h/exec";
  const FULL = 3*3600;
  const pad = n => String(n).padStart(2,'0');
  const state = { items:[], baseTz:'America/Sao_Paulo', serverNowMs:null, clientNowAtFetch:null, slaHours:3 };

  function loadState(){
    document.getElementById('status').textContent='Carregando...';
    const cb = 'onState_' + Math.random().toString(36).slice(2);
    window[cb] = function(data){
      delete window[cb];
      document.getElementById('status').textContent='';
      state.items = data.items||[];
      state.baseTz = data.baseTz;
      state.slaHours = data.slaHours;
      state.serverNowMs = data.now || Date.now();
      state.clientNowAtFetch = Date.now();
      render();
      startTick();
    };
    const s = document.createElement('script');
    s.src = APPS + '?fn=state&callback=' + cb;
    s.onerror = () => { document.getElementById('status').textContent='Erro ao carregar'; };
    document.body.appendChild(s);
  }

  function bucket(sec){
    if (sec==null) return 'safe';
    if (sec>=120*60) return 'safe';
    if (sec>=60*60)  return 'warn';
    if (sec>=30*60)  return 'risk';
    return 'crit';
  }
  function fmt(sec){
    if(sec==null) return '';
    const sign=sec<0?'-':'';
    const s=Math.abs(sec);
    const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60;
    return `${sign}${pad(h)}:${pad(m)}:${pad(ss)}`;
  }
  function css(s){ return s.replace(/[^a-z0-9]+/gi,'-').toLowerCase(); }

  function render(){
    const sel=document.getElementById('basin'); sel.innerHTML='';
    state.items.forEach(it=>{ const o=document.createElement('option'); o.value=it.basin; o.textContent=it.basin; sel.appendChild(o); });
    const grid=document.getElementById('grid'); grid.innerHTML='';
    state.items.forEach(it=>{
      const div=document.createElement('div'); div.className='basin';
      const k=bucket(it.remainingSec);
      const title=document.createElement('div'); title.className='title';
      const name=document.createElement('div'); name.textContent=it.basin; title.appendChild(name);
      const b=document.createElement('span'); b.className='badge '+k; b.textContent=({safe:'SEGURO',warn:'ATENÇÃO',risk:'RISCO',crit:'CRÍTICO'})[k]; title.appendChild(b);
      const sub=document.createElement('div'); sub.className='muted';
      const who = it.lastPlayer ? ` • por <b>${it.lastPlayer}</b>` : '';
      sub.innerHTML = it.lastIsoUtc
        ? `Último: <b>${it.lastIsoBase}</b> (${state.baseTz})${who} · <span class="muted">${it.lastIsoUtc} UTC</span>`
        : 'Nunca registrado';
      const due=document.createElement('div'); due.className='due';
      const id='cd-'+css(it.basin);
      due.innerHTML = it.nextDueIsoBase
        ? `Próx.: <b>${it.nextDueIsoBase}</b> (${state.baseTz}) · <span id="${id}"></span>`
        : '—';
      const bar=document.createElement('div'); bar.className='bar';
      const fill=document.createElement('div'); fill.className='fill '+k; bar.appendChild(fill);
      div.appendChild(title); div.appendChild(sub); div.appendChild(due); div.appendChild(bar);
      grid.appendChild(div);
    });
    document.getElementById('footer').textContent=`SLA ${state.slaHours}h · Exibição base: ${state.baseTz}`;
  }

  let tickTimer=null;
  function startTick(){
    if(tickTimer){ clearInterval(tickTimer); tickTimer=null; }
    const drift=(state.serverNowMs??Date.now())-(state.clientNowAtFetch??Date.now());
    const tick=()=>{
      const cards=document.querySelectorAll('.grid .basin');
      state.items.forEach((it, idx)=>{
        if(it.remainingSec==null) return;
        const now=Date.now()+drift;
        if(!it._nextDueMs) it._nextDueMs=state.serverNowMs + it.remainingSec*1000;
        const rem=Math.floor((it._nextDueMs - now)/1000);
        const el=document.getElementById('cd-'+css(it.basin));
        if(el) el.textContent=fmt(rem);
        const fill=cards[idx]?.querySelector('.fill');
        if(fill){
          const spent=Math.max(0, Math.min(FULL, FULL - Math.max(0, rem)));
          fill.style.width=((spent/FULL)*100).toFixed(1)+'%';
          const newK=bucket(rem);
          ['safe','warn','risk','crit'].forEach(c=>fill.classList.remove(c));
          fill.classList.add(newK);
          const badge=cards[idx]?.querySelector('.badge');
          if(badge){
            ['safe','warn','risk','crit'].forEach(c=>badge.classList.remove(c));
            badge.classList.add(newK);
            badge.textContent=({safe:'SEGURO',warn:'ATENÇÃO',risk:'RISCO',crit:'CRÍTICO'})[newK];
          }
        }
      });
    };
    tick(); tickTimer=setInterval(tick,1000);
  }

  function setNow(){
    const d=new Date();
    const v=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    document.getElementById('dt').value=v;
  }

  document.getElementById('f').addEventListener('submit', (ev)=>{
    const dt = document.getElementById('dt').value;
    const ms = dt ? new Date(dt).getTime() : Date.now();
    document.getElementById('typed').value = dt || '';
    document.getElementById('ms').value = String(ms);
    document.getElementById('tz').value = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
    document.getElementById('status').textContent='Enviando...';
  });

  window.addEventListener('message', (ev)=>{
    if (ev.data === 'ok'){
      document.getElementById('status').textContent='Registrado!';
      loadState();
    }else if (ev.data === 'error'){
      document.getElementById('status').textContent='Erro no envio';
    }
  });

  document.getElementById('nowBtn').addEventListener('click', setNow);
  document.getElementById('refreshBtn').addEventListener('click', loadState);

  setNow();
  loadState();
</script>
</body>
</html>
